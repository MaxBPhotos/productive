<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Focusifyr</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// ---------------- Firebase ----------------
const firebaseConfig = {
  apiKey: "AIzaSyByNjT5Uoe-eOAxyMCxNw10I3vyK2lgGkI",
  authDomain: "productivity-493dd.firebaseapp.com",
  projectId: "productivity-493dd",
  storageBucket: "productivity-493dd.appspot.com",
  messagingSenderId: "570358408560",
  appId: "1:570358408560:web:73a73ee1ac9ce87f16dbb5",
  measurementId: "G-PRQY1YW3HS"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

// ---------------- Globals ----------------
let user = null;
let currentWeek = 1;
let weekData = null;
let chartInstance = null;
const days = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];

// ---------------- Auth ----------------
window.googleLogin = async () => {
  try { await signInWithPopup(auth, provider); } 
  catch(e){ alert(e.message); }
};

onAuthStateChanged(auth, u => {
  if(u){
    user = u;
    document.getElementById("auth").style.display="none";
    document.getElementById("main").style.display="block";
    loadWeek(currentWeek);
    renderWeekTabs();
  }
});

// ---------------- Week Tabs ----------------
function renderWeekTabs(){
  const container = document.getElementById("weeks");
  container.innerHTML = "";
  for(let i=1;i<=4;i++){
    const btn = document.createElement("button");
    btn.textContent = "Week "+i;
    if(i===currentWeek) btn.classList.add("active");
    btn.onclick = () => { currentWeek=i; loadWeek(i); };
    container.appendChild(btn);
  }
}

// ---------------- Data ----------------
function createEmptyWeek(){
  return {
    days: Array.from({length:7},()=>({tasks:[false,false,false]})),
    habits: Array.from({length:5},()=>Array.from({length:7},()=>false))
  };
}

async function saveWeek(){
  if(!weekData) return;
  await setDoc(doc(db,"users",user.uid,"weeks","week"+currentWeek), weekData);
}

// ---------------- Load Week ----------------
async function loadWeek(week){
  renderWeekTabs();
  const ref = doc(db,"users",user.uid,"weeks","week"+week);
  const snap = await getDoc(ref);
  weekData = snap.exists()? snap.data(): createEmptyWeek();
  renderDays();
  renderHabits();
  renderChart();
}

// ---------------- Render Days ----------------
function renderDays(){
  const container = document.getElementById("days");
  container.innerHTML="";
  weekData.days.forEach((day,i)=>{
    let done = day.tasks.filter(t=>t).length;
    let pct = Math.round((done/day.tasks.length)*100);
    let div = document.createElement("div");
    div.className = "day";
    div.innerHTML = `<b>${days[i]}</b>
      <div class="circle" id="circle-${i}" style="background:conic-gradient(#4caf50 ${pct*3.6}deg,#eee 0deg)">${pct}%</div>
      ${day.tasks.map((t,j)=>`
        <div class="task">
          <input type="checkbox" data-day="${i}" data-task="${j}" ${t?"checked":""}>
          Task ${j+1}
        </div>
      `).join("")}
    `;
    container.appendChild(div);
  });

  // Attach change events
  document.querySelectorAll('.task input').forEach(el=>{
    el.onchange = async e=>{
      const day = parseInt(el.dataset.day);
      const task = parseInt(el.dataset.task);
      weekData.days[day].tasks[task] = el.checked;
      updateDayCircle(day);
      updateChart();
      await saveWeek();
    };
  });
}

// ---------------- Update Circle ----------------
function updateDayCircle(dayIndex){
  const day = weekData.days[dayIndex];
  const done = day.tasks.filter(t=>t).length;
  const pct = Math.round((done/day.tasks.length)*100);
  const circle = document.getElementById(`circle-${dayIndex}`);
  circle.textContent = pct+"%";
  circle.style.background = `conic-gradient(#4caf50 ${pct*3.6}deg,#eee 0deg)`;
}

// ---------------- Render Habits ----------------
function renderHabits(){
  const table = document.getElementById("habits");
  table.innerHTML="<tr><th>Habit</th>"+days.map(d=>`<th>${d}</th>`).join("")+"</tr>";
  weekData.habits.forEach((row,i)=>{
    let tr = `<tr><td>Habit ${i+1}</td>`;
    row.forEach((v,j)=>{
      tr += `<td><input type="checkbox" data-habit="${i}" data-day="${j}" ${v?"checked":""}></td>`;
    });
    tr += "</tr>";
    table.innerHTML += tr;
  });

  document.querySelectorAll('#habits input').forEach(el=>{
    el.onchange = async e=>{
      const h = parseInt(el.dataset.habit);
      const d = parseInt(el.dataset.day);
      weekData.habits[h][d] = el.checked;
      await saveWeek();
    };
  });
}

// ---------------- Chart ----------------
function renderChart(){
  const ctx = document.getElementById("chart");
  const values = weekData.days.map(d=>Math.round(d.tasks.filter(t=>t).length/3*100));
  if(chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx,{
    type:'line',
    data:{
      labels:days,
      datasets:[{
        label:'Daily Progress %',
        data:values,
        borderColor:'#4caf50',
        fill:false,
        tension:0.3
      }]
    },
    options:{responsive:true, maintainAspectRatio:false}
  });
}

function updateChart(){
  const values = weekData.days.map(d=>Math.round(d.tasks.filter(t=>t).length/3*100));
  chartInstance.data.datasets[0].data = values;
  chartInstance.update();
}
</script>

<style>
html, body {
  height: 100%;
  margin: 0;
  padding: 0;
  overflow-y: auto;
}
body{font-family:Inter,sans-serif;background:#f4f6f8}
.app{max-width:1200px;margin:20px auto;padding:20px}
h1{text-align:center}
button{padding:8px 14px;border:none;border-radius:6px;background:#111;color:white;cursor:pointer}
.week-tabs button.active{background:#4CAF50}
input{padding:6px;border-radius:6px;border:1px solid #ccc}
.grid{display:grid;grid-template-columns:repeat(7,1fr);gap:10px;margin-top:20px;width:100%}
.day{background:white;border-radius:12px;padding:10px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
.circle{width:80px;height:80px;border-radius:50%;margin:10px auto;display:flex;align-items:center;justify-content:center;font-weight:bold}
.task{display:flex;gap:6px;font-size:14px}
.habits table{width:100%;border-collapse:collapse}
.habits td,.habits th{border:1px solid #ddd;padding:6px;text-align:center}
canvas{width:100% !important;height:200px !important}
</style>
</head>
<body>
<div class="app">
<h1>Focusifyr</h1>
<div id="auth">
  <button onclick="googleLogin()">Sign in with Google</button>
</div>

<div id="main" style="display:none">
  <div class="week-tabs" id="weeks"></div>
  <canvas id="chart"></canvas>
  <div class="grid" id="days"></div>
  <h3>Daily Habits</h3>
  <div class="habits"><table id="habits"></table></div>
</div>
</div>
</body>
</html>
